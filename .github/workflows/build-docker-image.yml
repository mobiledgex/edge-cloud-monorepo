name: build-docker-image
on:
  pull_request:
    types: [opened, reopened]
jobs:
  build-docker-image:
    name: Build the edge-cloud image
    runs-on: ubuntu-latest
    steps:
      -
        name: Check out the monorepo
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.PAT }}
          submodules: recursive
      -
        name: Compute docker image meta
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: harbor.mobiledgex.net/mobiledgex-dev/edge-cloud
      -
        name: Compute build tag
        id: build-tag
        run: echo "::set-output name=BUILD_TAG::$(git describe --always --dirty=+), $(TZ=UTC date +'%Y-%m-%d'), $(echo -e '${{steps.meta.outputs.tags}}' | head -n 1 | cut -d':' -f2)"
      -
        name: Set up builder username
        run: git config --global user.name github
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      -
        name: Build edge-cloud image
        uses: docker/build-push-action@v2
        with:
          context: .
          push: no
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            REGISTRY=harbor.mobiledgex.net/mobiledgex-dev/edge-cloud
